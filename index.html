<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카메라 선택</title>
    <style>
        #preview {
            display: none;
            width: 640px;
            height: 480px;
        }
    </style>
</head>
<body>
    <h1>카메라 선택</h1>
    <select id="cameraSelect"></select>
    <input type="file" id="imageInput" accept="image/*">
    <video id="video" width="640" height="480" autoplay></video>
    <img id="preview" />
    <button id="capture">캡쳐</button>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

    <script>
        const videoElement = document.getElementById('video');
        const cameraSelect = document.getElementById('cameraSelect');
        const imageInput = document.getElementById('imageInput');
        const preview = document.getElementById('preview');
        const captureButton = document.getElementById('capture');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        // 사용 가능한 카메라 목록 가져오기
        navigator.mediaDevices.enumerateDevices().then(devices => {
            const videoDevices = devices.filter(device => device.kind === 'videoinput');

            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Camera ${index + 1}`;
                cameraSelect.appendChild(option);
            });

            // 첫 번째 카메라로 비디오 스트림 시작
            if (videoDevices.length > 0) {
                startStream(videoDevices[0].deviceId);
            }
        });

        cameraSelect.onchange = () => {
            if (cameraSelect.value === 'upload') {
                videoElement.style.display = 'none';
                preview.style.display = 'block';
            } else {
                videoElement.style.display = 'block';
                preview.style.display = 'none';
                startStream(cameraSelect.value);
            }
        };

        imageInput.onchange = (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
                videoElement.style.display = 'none';
            };
            reader.readAsDataURL(file);
        };

        function startStream(deviceId) {
            if (window.stream) {
                window.stream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    facingMode: { ideal: 'environment' }  // 모바일 환경일 때 후방 카메라 기본값 설정
                }
            };

            navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                window.stream = stream;
                videoElement.srcObject = stream;
            }).catch(error => {
                console.error('Error accessing media devices.', error);
            });
        }

        captureButton.onclick = () => {
            if (preview.style.display === 'block') {
                context.drawImage(preview, 0, 0, canvas.width, canvas.height);
            } else {
                context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            }
            const dataURL = canvas.toDataURL('image/png');
            analyzeImage(dataURL);
        };

        function analyzeImage(dataURL) {
            const img = new Image();
            img.src = dataURL;
            img.onload = () => {
                const color = getColorFromImage(img);
                let resultMessage;
                switch(color) {
                    case 'red': resultMessage = '빨강'; break;
                    case 'green': resultMessage = '초록'; break;
                    case 'blue': resultMessage = '파랑'; break;
                    case 'yellow': resultMessage = '빨강+초록'; break;
                    case 'magenta': resultMessage = '빨강+파랑'; break;
                    case 'cyan': resultMessage = '초록+파랑'; break;
                    case 'white': resultMessage = '빨강+초록+파랑'; break;
                    case 'neutral': resultMessage = '중립'; break;
                    default: resultMessage = '알 수 없음'; break;
                }
                alert(resultMessage);
            };
        }

        function getColorFromImage(img) {
            // 여기서 이미지를 분석하여 색상을 반환하는 로직을 구현
            // 예시로 'red'를 반환
            return 'red';
        }

        // 초기화
        const uploadOption = document.createElement('option');
        uploadOption.value = 'upload';
        uploadOption.text = '이미지 업로드';
        cameraSelect.appendChild(uploadOption);
    </script>
</body>
</html>
